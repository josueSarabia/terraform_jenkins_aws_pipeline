pipeline {
    environment {
        imageName = "mrbluetoo/simple-web-server:latest"
        customImage = ''
    }

    agent any
    stages {


        /* stage('Start Container for Testing') {
            steps {
                script {
                    sh 'cd app'
                    sh 'docker compose rm -f; docker compose up -d webapp'
                }
            }
        } */

        /* stage('Run Tests') {
            steps {
                script {
                    sh '''
                        cd app/src
                        npm install
                        npm test
                    '''
                }
            }
            post {
                success {
                    script {
                        sh 'docker compose down'
                    }
                }
                failure {
                    script {
                        sh 'docker compose down'
                    }
                }
            }
        } */

        stage('Build Image') {
            steps {
                script {
                    customImage = docker.build(imageName, "./app/")
                }
            }
        }

        stage('Push to Registry') {
            /* when {
                branch "main"
            } */
            steps {
                script {
                    docker.withRegistry('', 'DockerhubCredentials') {
                        customImage.push()
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    sh """
                    #!/bin/bash
                    sudo ssh ubuntu@52.203.112.163 << EOF
                    sudo docker run -p 8080:80 mrbluetoo/simple-web-server:latest
                    exit 0
                    << EOF
                    """
                }

                script {
                    sh """
                    #!/bin/bash
                    sudo ssh ubuntu@3.208.71.131 << EOF
                    sudo docker run -p 80:8080 mrbluetoo/simple-web-server:latest
                    exit 0
                    << EOF
                    """
                }
            }
        }
    }
}